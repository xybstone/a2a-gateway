name: Notify on Push to Slack

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'docs/**'
      - '.gitignore'
      - '.gitattributes'

jobs:
  notify-slack:
    name: Send notification to Slack
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # å‡†å¤‡æ¶ˆæ¯å†…å®¹
          export COMMIT_AUTHOR="${{ github.actor }}"
          export COMMIT_SHA="${{ github.sha }}"
          export COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          export COMMIT_URL="${{ github.event.head_commit.url }}"
          export BRANCH="${{ github.ref_name }}"
          export TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # è·å–å˜æ›´çš„æ–‡ä»¶
          export ADDED_FILES="${{ github.event.head_commit.added }}"
          export MODIFIED_FILES="${{ github.event.head_commit.modified }}"
          export CHANGED_FILES="${ADDED_FILES} ${MODIFIED_FILES}"
          
          # ä½¿ç”¨ jq æ„å»º JSON payloadï¼ˆä½¿ç”¨ --arg ä¼ é€’ç¯å¢ƒå˜é‡ï¼‰
          PAYLOAD=$(jq -n \
            --arg author="$COMMIT_AUTHOR" \
            --arg branch="$BRANCH" \
            --arg message="$COMMIT_MESSAGE" \
            --arg url="$COMMIT_URL" \
            --arg timestamp="$TIMESTAMP" \
            --arg files="$CHANGED_FILES" \
            '{"text": "ğŸ“¬ New commit to a2a-gateway\n\nğŸ‘¤ Author: \($author)\nğŸŒ¿ Branch: \($branch)\nğŸ“ Commit: \($message[:100])...\nğŸ”— URL: \($url)\nğŸ• Time: \($timestamp)\n\nğŸ“ Changed files:\n\($files)\n\nğŸ¤– ä¸‰å¼Ÿæ­£åœ¨åˆ†æè¿™æ¬¡æäº¤..."}')
          
          # å‘é€ Slack æ¶ˆæ¯
          curl -X POST "${SLACK_WEBHOOK_URL}" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"
          
          echo "Slack notification sent successfully"
