name: Notify on Push to Slack

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'docs/**'
      - '.gitignore'
      - '.gitattributes'

jobs:
  notify-slack:
    name: Send notification to Slack
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # å‡†å¤‡æ¶ˆæ¯å†…å®¹
          COMMIT_AUTHOR="${{ github.actor }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          BRANCH="${{ github.ref_name }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # è·å–å˜æ›´çš„æ–‡ä»¶
          ADDED_FILES="${{ github.event.head_commit.added }}"
          MODIFIED_FILES="${{ github.event.head_commit.modified }}"
          CHANGED_FILES="${ADDED_FILES} ${MODIFIED_FILES}"
          
          # ä½¿ç”¨ Python æ„å»º JSON payloadï¼ˆè‡ªåŠ¨å¤„ç†è½¬ä¹‰ï¼‰
          PAYLOAD=$(python3 <<PYTHON
import json
import os
import sys

# ä»ç¯å¢ƒå˜é‡è·å–æ•°æ®
commit_author = os.getenv('COMMIT_AUTHOR', '')
commit_sha = os.getenv('COMMIT_SHA', '')
commit_message = os.getenv('COMMIT_MESSAGE', '')
commit_url = os.getenv('COMMIT_URL', '')
branch = os.getenv('BRANCH', '')
timestamp = os.getenv('TIMESTAMP', '')
changed_files = os.getenv('CHANGED_FILES', '')

# æ ¼å¼åŒ–æ–‡ä»¶åˆ—è¡¨
if changed_files:
    files_list = [f for f in changed_files.split() if f]
    formatted_files = '\n'.join([f"- {f}" for f in files_list])
else:
    formatted_files = 'No files changed'

# æ„å»º Slack æ¶ˆæ¯
message = f"""ğŸ“¬ New commit to a2a-gateway

ğŸ‘¤ Author: {commit_author}
ğŸŒ¿ Branch: {branch}
ğŸ“ Commit: {commit_message[:100]}...
ğŸ”— URL: {commit_url}
ğŸ• Time: {timestamp}

ğŸ“ Changed files:
{formatted_files}

ğŸ¤– ä¸‰å¼Ÿæ­£åœ¨åˆ†æè¿™æ¬¡æäº¤...
"""

# æ„å»º JSON payload
data = {"text": message}

# è¾“å‡º JSONï¼ˆä¾› curl ä½¿ç”¨ï¼‰
print(json.dumps(data))
PYTHON
)
          
          # å‘é€ Slack æ¶ˆæ¯
          curl -X POST "${SLACK_WEBHOOK_URL}" \
            -H 'Content-Type: application/json' \
            -d "${PAYLOAD}"
          
          echo "Slack notification sent successfully"
